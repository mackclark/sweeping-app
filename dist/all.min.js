angular.module("streetSweeper",["geolocation"]).controller("sweeperSchedule",["$scope","$http","geolocation",function(e,o,t){function a(e,o){i=new google.maps.Map(document.getElementById("map-canvas"),{zoom:8,center:{lat:e,lng:o}})}function n(o,t){var a=o,n=t,r=[a,n],s=new google.maps.LatLng(r[0],r[1]);p.geocode({location:s},function(o,t){if(t==google.maps.GeocoderStatus.OK)if(o[1]){i.setZoom(11),l=new google.maps.Marker({position:s,map:i}),y.setContent(o[1].formatted_address),y.open(i,l),e.address=o,e.city=o[0].address_components[3].long_name,e.street=o[0].address_components[1].long_name;var a=Number(e.address[0].address_components[0].long_name);a%2!==0?e.side="odd":e.side="even",e.$apply(e.side),e.$apply(e.street),e.$apply(e.address),e.$apply(e.city),console.log(e.city),console.log("address",e.address)}else window.alert("No results found"),showList();else window.alert("Geocoder failed due to: "+t),showList()})}function r(){setTimeout(function(){angular.forEach(e.schedule,function(o){e.street==o.concatName&&e.side==o.property3&&(e.locationSweepDate=o.sweepDate)}),e.locationSweepDate.day==e.DateToday.dayVerbose&&e.locationSweepDate.instance1==e.DateToday.instance||e.locationSweepDate.instance2==e.DateToday.instance?(e.moveToday=!0,e.moveTomorrow=!1):e.locationSweepDate.day==e.DateTomorrow.dayVerbose&&e.locationSweepDate.instance1==e.DateTomorrow.instance||e.locationSweepDate.instance2==e.DateTomorrow.instance?(e.moveTomorrow=!0,e.moveToday=!1):(e.moveTomorrow=!1,e.moveToday=!1),e.$apply(e.locationSweepDate),e.comparing=!0},2e3)}function s(e,o,t,a,n){var r={month:0,day:0,date:0,year:0,hour:0,monthVerbose:"0",dayVerbose:"0",dateVerbose:"0"},s=new Array(7);s[0]="Sunday",s[1]="Monday",s[2]="Tuesday",s[3]="Wednesday",s[4]="Thursday",s[5]="Friday",s[6]="Saturday";var d=new Array(12);d[0]="January",d[1]="February",d[2]="March",d[3]="April",d[4]="May",d[5]="June",d[6]="July",d[7]="August",d[8]="September",d[9]="October",d[10]="November",d[11]="December";var c=s[e]+", "+d[t]+" "+o+", "+a,i=["","1st","2nd","3rd","4th","5th"],l=c.split(/[ ,]/),p=i[Math.ceil(l[3]/7)]+" "+l[0],y=i[Math.ceil(l[3]/7)];return r.month=t,r.day=e,r.year=a,r.date=o,r.instance=y,r.dayVerbose=s[e],r.monthVerbose=d[t],r.hour=n,r.dateVerbose=p,r}function d(){var o=new Date,t=o.getDay(),a=o.getDate(),n=o.getMonth(),r=o.getFullYear(),d=o.getHours();dateObjectToday=s(t,a,n,r,d),e.DateToday=dateObjectToday}var c;t.getLocation().then(function(t){e.coords={lat:t.coords.latitude,"long":t.coords.longitude},a(t.coords.latitude,t.coords.longitude),n(t.coords.latitude,t.coords.longitude),e.watch(e.city,function(){"Somerville"==e.city?c="somervilleschedule.json":"Boston"==e.city?c="boston.json":"Cambridge"==e.city?c="cambridge.json":alert("Sorry! we're not currently serving that area, but hopefully we can soon!"),c="somervilleschedule.json",c&&o.get(c).success(function(o,t,a,n){e.schedule=o.results.collection1,"somervilleschedule.json"==c?angular.forEach(e.schedule,function(e){e.concatName=e.property1+" "+e.property2,e.sweepDate={sweepDate:e.property4,instance1:e.property4.split(" and")[0],instance2:"1st"==e.property4.split(" and")[0]?"3rd":"4th",day:e.property4.split(" ")[3]}}):"boston.json"==c&&(angular.forEach(e.schedule,function(e){e.sweepDate=String(e.property5.text)}),angular.forEach(e.schedule,function(e){e.concatName=e.property1,e.sweepDates={instance1:e.sweepDate.split(" ")[0],instance2:"1st"==e.sweepDate.split(" ")[0]?"3rd":"4th",day:String(e.sweepDate.split("\n")[0]).split(" ")}}))}).error(function(e,o,t,a){alert("oops")})})}),e.streets=e.schedule,e.selectedSpot="",e.chooseStreet=!1,e.moveToday=!1,e.moveTomorrow=!1,e.comparing=!1,e.explanation,e.begin=0,e.end=10,e.showList=function(){e.chooseStreet===!1?e.chooseStreet=!0:e.chooseStreet=!1},e.enterParkingSpot=function(o){e.selectedSpot=$('[type="radio"]:checked').val(),e.selectedSpot=jQuery.parseJSON(e.selectedSpot)},e.loadMore=function(){e.begin<e.schedule.length-9&&(e.begin+=10,e.end+=10)},e.loadFewer=function(){0!==e.begin&&(e.begin-=10,e.end-=10)};var i,l,p=new google.maps.Geocoder,y=new google.maps.InfoWindow;e.address,e.locationSweepDate,e.compareDate=function(o,s){e.chooseStreet?e.selectedSpot.sweepDate.day==e.DateToday.dayVerbose&&(e.selectedSpot.sweepDate.instance1==e.DateToday.instance||e.selectedSpot.sweepDate.instance2==e.DateToday.instance)&&e.DateToday.hour<12?(e.moveToday=!0,e.moveTomorrow=!1,e.explanation="You need to move your car! "+e.selectedSpot.concatName+" will be swept today between 8 AM and 12 PM."):e.selectedSpot.sweepDate.day!=e.DateToday.dayVerbose||e.selectedSpot.sweepDate.instance1!=e.DateToday.instance&&e.selectedSpot.sweepDate.instance2!=e.DateToday.instance?e.selectedSpot.sweepDate.day!=e.DateTomorrow.dayVerbose||e.selectedSpot.sweepDate.instance1!=e.DateTomorrow.instance&&e.selectedSpot.sweepDate.instance2!=e.DateTomorrow.instance?(e.moveTomorrow=!1,e.moveToday=!1,e.explanation="breathe a sigh of relief- your car can stay put for now."):(e.moveTomorrow=!0,e.moveToday=!1,e.explanation="Better move you car before tomorrow at 8AM- "+e.selectedSpot.concatName+" will be swept tomorrow between 8AM and 12 PM"):(e.moveToday=!1,e.moveTomorrow=!1,e.explanation="Youre good to go- "+e.selectedSpot.concatName+" was already swept today between 8 AM and 12 PM."):t.getLocation().then(function(o){e.coords={lat:o.coords.latitude,"long":o.coords.longitude},a(o.coords.latitude,o.coords.longitude),n(o.coords.latitude,o.coords.longitude),r()}),e.comparing=!0},e.DateToday,e.DateTomorrow;var u=new Date;u.setDate(u.getDate()+1);var m=u.getDay(),w=u.getDate(),g=u.getMonth(),D=u.getFullYear();dateObjectTomorrow=s(m,w,g,D),e.DateTomorrow=dateObjectTomorrow,d(),e.TodaysDate=dateObjectToday.dateVerbose}]);